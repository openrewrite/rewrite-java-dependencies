/*
 * Copyright 2021 the original author or authors.
 * <p>
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * <p>
 * https://www.apache.org/licenses/LICENSE-2.0
 * <p>
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.openrewrite.java.dependencies;

import org.junit.jupiter.api.Disabled;
import org.junit.jupiter.api.Test;
import org.openrewrite.DocumentExample;
import org.openrewrite.java.dependencies.table.VulnerabilityReport;
import org.openrewrite.test.RecipeSpec;
import org.openrewrite.test.RewriteTest;

import static org.assertj.core.api.Assertions.assertThat;
import static org.openrewrite.gradle.Assertions.buildGradle;
import static org.openrewrite.gradle.toolingapi.Assertions.withToolingApi;
import static org.openrewrite.maven.Assertions.pomXml;

class DependencyVulnerabilityCheckTest implements RewriteTest {

    @Override
    public void defaults(RecipeSpec spec) {
        spec.recipe(new DependencyVulnerabilityCheck("runtime", true, true));
    }

    @DocumentExample
    @Test
    void gradle() {
        rewriteRun(
          spec -> spec.beforeRecipe(withToolingApi()),
          //language=groovy
          buildGradle(
            """
              plugins {
                id 'java'
              }
              
              repositories {
                  mavenCentral()
              }
              
              dependencies {
                  implementation 'org.apache.logging.log4j:log4j:2.13.1'
              }
              """,
            """
              /*~~(This project has the following vulnerabilities:
              Dependency org.apache.logging.log4j:log4j:2.13.1 has CVE-2020-9488 (LOW severity, fixed in 2.13.2) - Improper validation of certificate with host mismatch in Apache Log4j SMTP appender)~~>*/plugins {
                id 'java'
              }
              
              repositories {
                  mavenCentral()
              }
              
              dependencies {
                  implementation 'org.apache.logging.log4j:log4j:2.13.2'
              }
              """
          )
        );
    }

    @Test
    void gradleTransitive() {
        rewriteRun(
          spec -> spec.beforeRecipe(withToolingApi())
            .recipe(new DependencyVulnerabilityCheck(null, true, false)),
          //language=groovy
          buildGradle(
            """
              plugins { id 'java' }
              repositories { mavenCentral() }
              
              dependencies {
                  implementation 'org.openrewrite:rewrite-java:7.0.0'
              }
              """,
            """
              plugins { id 'java' }
              repositories { mavenCentral() }
              
              dependencies {
                  constraints {
                      implementation('com.fasterxml.jackson.core:jackson-databind:2.12.7.1') {
                          because 'CVE-2022-42003'
                      }
                  }
              
                  implementation 'org.openrewrite:rewrite-java:7.0.0'
              }
              """
          )
        );
    }

    @Test
    void maven() {
        rewriteRun(
          spec -> spec
            .dataTable(VulnerabilityReport.Row.class, rows -> {
                assertThat(rows).isNotEmpty();
                assertThat(rows).filteredOn(VulnerabilityReport.Row::isFixWithVersionUpdateOnly).isNotEmpty();
                assertThat(rows).extracting(VulnerabilityReport.Row::getCWEs).anySatisfy(cwes -> assertThat(cwes).isNotEmpty());
            }),
          //language=xml
          pomXml(
            """
              <project>
                <groupId>com.mycompany.app</groupId>
                <artifactId>my-app</artifactId>
                <version>1</version>
                <dependencies>
                  <dependency>
                    <groupId>org.springframework.security</groupId>
                    <artifactId>spring-security-core</artifactId>
                    <version>4.2.13.RELEASE</version>
                  </dependency>
                  <dependency>
                    <groupId>org.apache.logging.log4j</groupId>
                    <artifactId>log4j</artifactId>
                    <version>2.13.1</version>
                  </dependency>
                </dependencies>
              </project>
              """,
            """
              <project>
                <groupId>com.mycompany.app</groupId>
                <artifactId>my-app</artifactId>
                <version>1</version>
                <dependencies>
                  <!--~~(This dependency includes org.springframework:spring-context:4.3.23.RELEASE which has the following vulnerabilities:
              CVE-2022-22968 (HIGH severity, fixed in 5.2.21) - Improper handling of case sensitivity in Spring Framework)~~>--><dependency>
                    <groupId>org.springframework.security</groupId>
                    <artifactId>spring-security-core</artifactId>
                    <version>4.2.13.RELEASE</version>
                  </dependency>
                  <!--~~(This dependency includes org.apache.logging.log4j:log4j:2.13.1 which has the following vulnerabilities:
              CVE-2020-9488 (LOW severity, fixed in 2.13.2) - Improper validation of certificate with host mismatch in Apache Log4j SMTP appender)~~>--><dependency>
                    <groupId>org.apache.logging.log4j</groupId>
                    <artifactId>log4j</artifactId>
                    <version>2.13.2</version>
                  </dependency>
                </dependencies>
              </project>
              """
          )
        );
    }

    @Test
    @Disabled("https://github.com/openrewrite/rewrite-java-dependencies/pull/7")
    void mavenSnakeyamlMajorMinor() {
        rewriteRun(
          spec -> spec
            .recipe(new DependencyVulnerabilityCheck("compile", false, false)),
          //language=xml
          pomXml(
            """
              <?xml version="1.0" encoding="UTF-8"?>
              <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
                <modelVersion>4.0.0</modelVersion>
                <groupId>com.example</groupId>
                <artifactId>openrewrite-playground</artifactId>
                <version>0.0.1-SNAPSHOT</version>
                <dependencies>
                  <dependency>
                    <groupId>org.yaml</groupId>
                    <artifactId>snakeyaml</artifactId>
                    <version>1.29</version>
                  </dependency>
                </dependencies>
              </project>
              """,
            """
              <?xml version="1.0" encoding="UTF-8"?>
              <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
                <modelVersion>4.0.0</modelVersion>
                <groupId>com.example</groupId>
                <artifactId>openrewrite-playground</artifactId>
                <version>0.0.1-SNAPSHOT</version>
                <dependencies>
                  <dependency>
                    <groupId>org.yaml</groupId>
                    <artifactId>snakeyaml</artifactId>
                    <version>1.33</version>
                  </dependency>
                </dependencies>
              </project>
              """
          )
        );
    }

    @Test
    void mavenJacksonMajorMinorPatch() {
        rewriteRun(
          spec -> spec
            .recipe(new DependencyVulnerabilityCheck("compile", false, false)),
          //language=xml
          pomXml(
            """
              <?xml version="1.0" encoding="UTF-8"?>
              <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
                <modelVersion>4.0.0</modelVersion>
                <groupId>com.example</groupId>
                <artifactId>openrewrite-playground</artifactId>
                <version>0.0.1-SNAPSHOT</version>
                <dependencies>
                  <dependency>
                    <groupId>com.fasterxml.jackson.core</groupId>
                    <artifactId>jackson-databind</artifactId>
                    <version>2.13.0</version>
                  </dependency>
                </dependencies>
              </project>
              """,
            """
              <?xml version="1.0" encoding="UTF-8"?>
              <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
                <modelVersion>4.0.0</modelVersion>
                <groupId>com.example</groupId>
                <artifactId>openrewrite-playground</artifactId>
                <version>0.0.1-SNAPSHOT</version>
                <dependencies>
                  <dependency>
                    <groupId>com.fasterxml.jackson.core</groupId>
                    <artifactId>jackson-databind</artifactId>
                    <version>2.13.4.2</version>
                  </dependency>
                </dependencies>
              </project>
              """
          )
        );
    }
}
